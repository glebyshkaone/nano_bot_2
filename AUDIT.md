# Отчёт по аудиту безопасности и качества для `nano_bot_2`

## Область проверки
Полный обзор репозитория на основе статического анализа Telegram-бота, административных утилит и интеграции с Supabase.

## Ключевые выводы

1. **Секреты Supabase уровня service-role в конфигурации выполнения (Высокий).** Бот использует ключ Service Role Supabase для всех запросов к базе данных (`SUPABASE_SERVICE_ROLE_KEY`) и отправляет его с каждым REST-запросом. Компрометация процесса бота раскроет неограниченный доступ к базе, обходя Row Level Security. Предпочитайте минимально привилегированный ключ или выделенный бэкенд-прокси для посредничества в запросах и избегайте включения service-role секрета в среду выполнения бота.【F:config.py†L11-L36】

2. **Платёжный поток доверяет управляемой клиентом полезной нагрузке без проверки суммы (Средний).** Начисление токенов при успешной оплате строится только на префиксе полезной нагрузки счёта без проверки `total_amount` или `currency`, возвращаемых Telegram. Если обработчик получит поддельное или несоответствующее обновление, пользователь может получить произвольное количество токенов. Проверяйте `total_amount`/`currency` на соответствие ожидаемым значениям перед вызовом `add_tokens` и отклоняйте платежи, не совпадающие с выставленным счётом.【F:user/handlers.py†L430-L510】

3. **Пользовательские сообщения об ошибках раскрывают внутренние детали исключений (Средний).** При неудачах генерации бот возвращает пользователям строку Python-исключения, раскрывая внутренние ошибки и потенциально чувствительные данные (например, трассировки или ответы сторонних сервисов). Замените детальные исключения дружественными сообщениями, а детали журналируйте только на сервере.【F:user/handlers.py†L300-L352】

4. **Зависимости не закреплены (Низкий).** В `requirements.txt` указаны широкие пакеты без фиксации версий, что делает сборки нерепродуцируемыми и повышает риски цепочки поставок. Закрепите версии библиотек (и при необходимости хэши) для детерминированных сборок и предсказуемой безопасности.【F:requirements.txt†L1-L4】

## Рекомендации
- Ротуйте и ограничивайте полномочия учётных данных Supabase; добавьте тонкий бэкенд или RLS-безопасные API-маршруты, чтобы не раскрывать возможности service-role процессу бота.
- Усильте платёжный конвейер, проверяя `total_amount`, `currency` и токен провайдера, а также игнорируя полезные нагрузки, не совпадающие с выставленными счетами.
- Санируйте пользовательские ошибки при генерации; логируйте все детали с ID корреляции, но возвращайте пользователям нейтральные сообщения о сбоях.
- Закрепите версии зависимостей и внедрите автоматическое сканирование уязвимостей (например, Dependabot, `pip-audit`) для мониторинга рисков сторонних библиотек.
